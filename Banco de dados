
CREATE TABLE ncm (
    codigo CHAR(8) PRIMARY KEY,
    descricao TEXT,
    capitulo CHAR(2),
    posicao CHAR(4),
    subposicao CHAR(6),
    ativo BOOLEAN DEFAULT 1
);

CREATE TABLE categoria_tributaria (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100),
    descricao TEXT
);

INSERT INTO categoria_tributaria (nome) VALUES
('Tributação Padrão'),
('Tributação Reduzida'),
('Alíquota Zero'),
('Sujeito ao Imposto Seletivo'),
('Revisão Necessária');

CREATE TABLE regra_ncm (
    id INT AUTO_INCREMENT PRIMARY KEY,
    tipo ENUM('capitulo','posicao','subposicao','ncm'),
    valor VARCHAR(8),
    categoria_id INT,
    percentual_reducao DECIMAL(5,2) NULL,
    incide_is BOOLEAN DEFAULT 0,
    observacao TEXT,
    FOREIGN KEY (categoria_id) REFERENCES categoria_tributaria(id)
);



CREATE TABLE clientes (
    id INT AUTO_INCREMENT PRIMARY KEY,

    razao_social VARCHAR(255) NOT NULL,
    nome_fantasia VARCHAR(255),
    cnpj CHAR(14) NOT NULL,

    contador_id INT NULL,

    data_cadastro DATETIME DEFAULT CURRENT_TIMESTAMP,

    UNIQUE KEY uk_clientes_cnpj (cnpj)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


CREATE TABLE uploads (
    id INT AUTO_INCREMENT PRIMARY KEY,

    cliente_id INT NOT NULL,

    nome_arquivo VARCHAR(255) NOT NULL,
    nome_original VARCHAR(255) NOT NULL,

    regras_versao VARCHAR(50) DEFAULT 'v1',
    observacao VARCHAR(255),

    data_upload DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (cliente_id)
        REFERENCES clientes(id)
        ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE produtos (
    id INT AUTO_INCREMENT PRIMARY KEY,

    upload_id INT NOT NULL,

    codigo VARCHAR(50),
    descricao VARCHAR(255),
    ncm CHAR(8),
    preco DECIMAL(15,2),

    capitulo CHAR(2),
    categoria VARCHAR(100),

    ibs DECIMAL(5,4),
    cbs DECIMAL(5,4),

    risco ENUM('baixo','medio','alto') DEFAULT 'baixo',
    observacao VARCHAR(255),

    data_criacao DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (upload_id)
        REFERENCES uploads(id)
        ON DELETE CASCADE,

    INDEX idx_produtos_upload (upload_id),
    INDEX idx_produtos_ncm (ncm),
    INDEX idx_produtos_categoria (categoria)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
